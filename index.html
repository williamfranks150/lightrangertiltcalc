<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Light Ranger Tilt Calculator</title>

  <!-- iOS standalone -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --pad: 18px;
      --border: rgba(255,255,255,0.22);
      --field-bg: rgba(255,255,255,0.06);
      --btn-bg: rgba(255,255,255,0.12);
    }

    html, body { height: 100%; margin: 0; background:#000; color:#fff; }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      padding:
        calc(env(safe-area-inset-top) + var(--pad))
        calc(env(safe-area-inset-right) + var(--pad))
        calc(env(safe-area-inset-bottom) + var(--pad))
        calc(env(safe-area-inset-left) + var(--pad));
      box-sizing:border-box;
    }

    .app{
      min-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      max-width: 640px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }

    h2{
      font-size: 1.9rem;
      margin: 0 0 8px 0;
      text-align:center;
      font-weight:700;
    }

    label, .frame-height-label{
      width:100%;
      display:block;
      margin-top:10px;
      font-weight:700;
      font-size:1.05rem;
      text-align:center;
    }

    input, select{
      width:100%;
      padding:12px 10px;
      margin-top:6px;
      font-size:1.25rem;
      text-align:center;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--field-bg);
      color:#fff;
      box-sizing:border-box;
      outline:none;
    }

    .inline-group{
      display:flex;
      gap:12px;
      width:100%;
    }
    .inline-group label{
      flex:1;
      margin-top:0;
      font-weight:700;
    }

    .radio-group{
      display:flex;
      justify-content:center;
      gap:18px;
      flex-wrap:wrap;
      width:100%;
      margin-top:6px;
    }
    .radio-group label{
      font-weight:500;
      font-size:1.05rem;
      width:auto;
      margin-top:0;
    }
    .radio-group input{
      width:auto;
      margin:0 6px 0 0;
    }

    .btn-row{
      width:100%;
      display:flex;
      justify-content:center;
      margin-top:14px;
    }

    #calcBtn{
      width:100%;
      padding:12px 10px;
      font-size:1.25rem;
      font-weight:700;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.28);
      background:var(--btn-bg);
      color:#fff;
    }

    #result{
      margin-top:16px;
      font-size:2.0rem;
      font-weight:800;
      text-align:center;
      width:100%;
    }

    #resetBtn{
      margin-top:18px;
      background:transparent;
      border:none;
      color:rgba(255,255,255,0.85);
      font-size:1.05rem;
      font-weight:300;
      padding:8px 10px;
    }
  </style>
</head>

<body>
  <div class="app">
    <h2>Light Ranger Tilt Calculator</h2>

    <label for="focal">Focal Length</label>
    <input type="number" id="focal" inputmode="decimal" />

    <label>Subject Distance to Focal Plane</label>
    <div class="inline-group">
      <label>Feet<br><input type="number" id="feet" inputmode="numeric" /></label>
      <label>Inches<br><input type="number" id="inches" inputmode="decimal" /></label>
    </div>

    <div class="frame-height-label" style="margin-top: 10px;">Frame Height</div>
    <div class="radio-group">
      <label><input type="radio" name="frame" value="top" checked /> Top Third</label>
      <label><input type="radio" name="frame" value="middle" /> Middle</label>
      <label><input type="radio" name="frame" value="bottom" /> Bottom Third</label>
    </div>

    <label style="font-weight:700; margin-top: 10px;">Light Ranger Sensor Distance to Focal Plane</label>
    <div class="inline-group">
      <label>Horizontal Offset (in)<br><input type="number" id="lr_offset" inputmode="decimal" /></label>
      <label>Vertical Offset (in)<br><input type="number" id="lr_height" inputmode="decimal" /></label>
    </div>

    <label for="sensorMode">Image Format</label>
    <select id="sensorMode">
      <option value="">-- Select Format --</option>

      <optgroup label="ARRI">
        <option value="5120,2880,22.36">ARRIRAW 5.1K (5120×2880)</option>
        <option value="4608,3164,24.54">ARRIRAW 4.6K (4608×3164)</option>
        <option value="4608,2592,20.10">ProRes 4.6K 16:9 (4608×2592)</option>
        <option value="4096,2048,16.48">ProRes 4K 2:1 (4096×2048)</option>
        <option value="3840,2160,18.66">ProRes UHD (3840×2160)</option>
        <option value="2880,2160,14.66">ProRes 2.8K Ana (2880×2160)</option>
      </optgroup>

      <optgroup label="Sony">
        <option value="8192,3432,18.56">8.2K 2.39:1 (8192×3432)</option>
        <option value="7680,4320,24.00">7.6K 16:9 (7680×4320)</option>
        <option value="5480,2296,13.90">5.5K 2.39:1 (5480×2296)</option>
      </optgroup>

      <optgroup label="RED">
        <option value="8192,4320,20.00">8K FF (8192×4320)</option>
        <option value="6144,2592,12.80">6K S35 (6144×2592)</option>
        <option value="5120,2160,10.66">5K S35 (5120×2160)</option>
        <option value="4480,1920,10.80">4.5K WS (4480×1920)</option>
      </optgroup>

      <option value="custom">Custom / Manual</option>
    </select>

    <div class="btn-row">
      <button id="calcBtn" type="button">CALCULATE</button>
    </div>

    <div id="result">Tilt Angle —</div>
    <button id="resetBtn" type="button">RESET</button>
  </div>

  <script>
    // PWA offline (optional)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
    }

    // internal-only values (not shown in UI)
    let sensorHeightMM = null;
    let customSensorHeightMM = null;

    function saveField(id){
      const el = document.getElementById(id);
      if (!el) return;
      localStorage.setItem(id, el.value ?? '');
    }

    function saveFrame(){
      const frame = document.querySelector('input[name="frame"]:checked');
      if (frame) localStorage.setItem('frame', frame.value);
    }

    function restoreAll(){
      const ids = ['focal','feet','inches','lr_height','lr_offset','sensorMode','customSensorMM'];
      for (const k of ids){
        const v = localStorage.getItem(k);
        if (v === null) continue;
        const el = document.getElementById(k);
        if (el) el.value = v;
      }

      const savedFrame = localStorage.getItem('frame');
      if (savedFrame){
        const r = document.querySelector(`input[name="frame"][value="${savedFrame}"]`);
        if (r) r.checked = true;
      }
    }

    function updateSensorValues(){
      const mode = document.getElementById("sensorMode").value;

      if (mode === "custom") {
        sensorHeightMM = customSensorHeightMM; // may be null until user sets it elsewhere
        return;
      }

      if (!mode){
        sensorHeightMM = null;
        return;
      }

      const parts = mode.split(",");
      const height = parseFloat(parts[2]);
      sensorHeightMM = Number.isNaN(height) ? null : height;
    }

    function normalizeNumbers(){
      const fEl = document.getElementById("focal");
      if (fEl.value !== "") {
        const f = Number(fEl.value);
        if (!Number.isNaN(f)) fEl.value = String(Math.ceil(f));
      }

      const inEl = document.getElementById("inches");
      if (inEl.value !== "") {
        const inch = Number(inEl.value);
        if (!Number.isNaN(inch)) inEl.value = String(Math.ceil(inch));
      }

      const ftEl = document.getElementById("feet");
      if (ftEl.value !== "") {
        const ft = Number(ftEl.value);
        if (!Number.isNaN(ft)) ftEl.value = String(Math.trunc(ft));
      }

      saveField('focal'); saveField('feet'); saveField('inches');
    }

    function calculateTilt(){
      try {
        normalizeNumbers();

        const f = parseFloat(document.getElementById("focal").value);
        const ft = parseFloat(document.getElementById("feet").value);
        const inch = parseFloat(document.getElementById("inches").value);
        const h = parseFloat(document.getElementById("lr_height").value);
        const z = parseFloat(document.getElementById("lr_offset").value);

        if (
          Number.isNaN(f) || Number.isNaN(ft) || Number.isNaN(inch) ||
          Number.isNaN(h) || Number.isNaN(z) ||
          f === 0 || sensorHeightMM === null
        ){
          document.getElementById("result").innerText = "Tilt Angle —";
          return;
        }

        const d = (ft * 12) + inch;                 // inches
        const horizontal_leg = d - z;
        const base_angle = Math.atan(-h / horizontal_leg) * (180 / Math.PI);
        const vfov = 2 * Math.atan((sensorHeightMM / 2) / f) * (180 / Math.PI);

        const frame_choice = document.querySelector('input[name="frame"]:checked')?.value ?? "top";
        let frame_pos = 0.25;
        if (frame_choice === "middle") frame_pos = 0.5;
        else if (frame_choice === "top") frame_pos = 0.75;

        const offset = (vfov / 2) * (0.5 - frame_pos);
        const final_angle = base_angle + offset;

        document.getElementById("result").innerText = `Tilt Angle: ${final_angle.toFixed(2)}°`;
      } catch {
        document.getElementById("result").innerText = "Tilt Angle —";
      }
    }

    function clearFields(){
      const ids = ['focal','feet','inches','lr_height','lr_offset','sensorMode','customSensorMM'];
      for (const id of ids) localStorage.removeItem(id);

      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      localStorage.removeItem('frame');
      document.querySelector('input[name="frame"][value="top"]').checked = true;

      sensorHeightMM = null;
      customSensorHeightMM = null;

      document.getElementById("result").innerText = "Tilt Angle —";
    }

    // wiring (save-only, no auto-calc)
    window.addEventListener('load', () => {
      restoreAll();
      updateSensorValues();

      ['focal','feet','inches','lr_height','lr_offset'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => saveField(id));
        el.addEventListener('change', () => saveField(id));
      });

      document.getElementById('sensorMode').addEventListener('change', () => {
        saveField('sensorMode');
        updateSensorValues();
      });

      document.querySelectorAll('input[name="frame"]').forEach(r => {
        r.addEventListener('change', saveFrame);
      });

      document.getElementById('calcBtn').addEventListener('click', calculateTilt);
      document.getElementById('resetBtn').addEventListener('click', clearFields);

      document.getElementById("result").innerText = "Tilt Angle —";
    });
  </script>
</body>
</html>
