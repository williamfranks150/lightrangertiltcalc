<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Light Ranger Tilt Calculator</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="LR Tilt" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --line:rgba(255,255,255,.18);
      --field:rgba(255,255,255,.08);
      --btn:rgba(255,255,255,.14);
      --btnline:rgba(255,255,255,.25);
    }
    html, body { height: 100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;

      padding:
        calc(env(safe-area-inset-top) + 18px)
        calc(env(safe-area-inset-right) + 18px)
        calc(env(safe-area-inset-bottom) + 18px)
        calc(env(safe-area-inset-left) + 18px);

      display:flex;
      justify-content:center;
      align-items:flex-start;
      box-sizing:border-box;
      text-align:center;
    }
    .wrap{ width:min(560px,100%); }

    h2{
      margin:10px 0 18px;
      font-size:28px;
      font-weight:700;
    }

    label{
      display:block;
      margin-top:14px;
      margin-bottom:6px;
      font-weight:700;
      font-size:14px;
      text-align:center;
    }

    input, select, button{
      width:100%;
      box-sizing:border-box;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--field);
      color:var(--fg);
      padding:12px;
      font-size:18px;
      text-align:center;
      outline:none;
    }

    .inline-group{
      display:flex;
      gap:10px;
      justify-content:center;
    }
    .inline-group label{
      flex:1;
      margin-top:0;
      margin-bottom:0;
      font-weight:700;
      font-size:14px;
    }

    .radio-title{
      margin-top:16px;
      font-weight:800;
      font-size:14px;
    }

    .radio-group{
      margin-top:8px;
      display:flex;
      justify-content:center;
      gap:18px;
      flex-wrap:wrap;
    }
    .radio-group label{
      font-weight:500;
      font-size:16px;
      width:auto;
      margin:0;
    }
    .radio-group input{ width:auto; }

    .divider{
      margin-top:14px;
      height:1px;
      background:rgba(255,255,255,.12);
    }

    #calcBtn{
      margin-top:18px;
      font-weight:800;
      background:var(--btn);
      border:1px solid var(--btnline);
    }

    #result{
      margin-top:18px;
      font-size:34px;
      font-weight:900;
    }

    #resetBtn{
      margin-top:10px;
      background:transparent;
      border:none;
      font-size:16px;
      color:rgba(255,255,255,.75);
      padding:10px 0;
      width:auto;
    }
  </style>
</head>

<body>
<div class="wrap">

  <h2>Light Ranger Tilt Calculator</h2>

  <label for="focal">Focal Length</label>
  <input type="number" id="focal" inputmode="decimal" />

  <label>Subject Distance to Focal Plane</label>
  <div class="inline-group">
    <label>Feet<br><input type="number" id="feet" inputmode="numeric" /></label>
    <label>Inches<br><input type="number" id="inches" inputmode="decimal" /></label>
  </div>

  <div class="radio-title">Frame Height</div>
  <div class="radio-group">
    <label><input type="radio" name="frame" value="top" checked> Top Third</label>
    <label><input type="radio" name="frame" value="middle"> Middle</label>
    <label><input type="radio" name="frame" value="bottom"> Bottom Third</label>
  </div>

  <label style="margin-top:16px;">Light Ranger Sensor Distance to Focal Plane</label>
  <div class="inline-group">
    <label>Horizontal Offset (in)<br><input type="number" id="lr_offset" inputmode="decimal" /></label>
    <label>Vertical Offset (in)<br><input type="number" id="lr_height" inputmode="decimal" /></label>
  </div>

  <div class="divider"></div>

  <label for="cameraBody">Camera Body</label>
  <select id="cameraBody">
    <option value="">-- Select Body --</option>
  </select>

  <label for="formatMode">Format / Sensor Mode</label>
  <select id="formatMode" disabled>
    <option value="">-- Select Format --</option>
  </select>

  <button id="calcBtn" type="button">CALCULATE</button>

  <div id="result">Tilt Angle —</div>
  <button id="resetBtn" type="button">RESET</button>

</div>

<script>
/* Sensor height (mm) stays internal; no visible vres/sensor boxes */
const CAMERA_DB = {
  "ARRI ALEXA 35": [
    { label:"4.6K 3:2 Open Gate (4608×3164)", vmm:19.22 },
    { label:"4.6K 16:9 (4608×2592)",         vmm:15.75 },
    { label:"4K 16:9 (4096×2304)",           vmm:14.00 },
    { label:"UHD (3840×2160)",               vmm:13.12 },
    { label:"4K 2:1 (4096×2048)",            vmm:12.44 },
    { label:"3.3K 6:5 (3328×2790)",          vmm:16.95 },
    { label:"3K 1:1 (3072×3072)",            vmm:18.66 },
    { label:"2K S16 (2048×1152)",            vmm:7.00 }
  ],

  "ARRI ALEXA Mini LF": [
    { label:"LF Open Gate 3:2 (4448×3096)",  vmm:25.54 },
    { label:"LF 2.39:1 (4448×1856)",         vmm:15.31 },
    { label:"LF 16:9 (3840×2160)",           vmm:17.82 },
    { label:"LF 1:1 (2880×2880)",            vmm:23.76 }
  ],

  "Sony VENICE": [
    { label:"6K FF 3:2",                     vmm:24.00 },
    { label:"6K FF 17:9",                    vmm:19.00 },
    { label:"5.7K FF 16:9",                  vmm:19.00 },
    { label:"4K S35 4:3 (Ana)",              vmm:18.00 },
    { label:"4K S35 16:9",                   vmm:12.80 }
  ],

  "RED KOMODO 6K": [
    { label:"6K 17:9 (6144×3240)",           vmm:14.26 },
    { label:"6K 2:1 (6144×3072)",            vmm:13.52 },
    { label:"6K 2.4:1 (6144×2574)",          vmm:11.32 },
    { label:"6K 16:9 (5760×3240)",           vmm:14.26 }
  ]
};

const LS = {
  focal:"focal", feet:"feet", inches:"inches",
  lr_offset:"lr_offset", lr_height:"lr_height",
  cameraBody:"cameraBody", formatMode:"formatMode",
  frame:"frame"
};

const $ = (id) => document.getElementById(id);
let activeSensorMM = null;

function save(k, v){ localStorage.setItem(k, String(v ?? "")); }
function load(k){ return localStorage.getItem(k); }
function del(k){ localStorage.removeItem(k); }

function populateBodies(){
  Object.keys(CAMERA_DB).sort().forEach(body=>{
    const o = document.createElement("option");
    o.value = body;
    o.textContent = body;
    $("cameraBody").appendChild(o);
  });
}

function populateFormats(body){
  const sel = $("formatMode");
  sel.innerHTML = `<option value="">-- Select Format --</option>`;
  const list = CAMERA_DB[body] || [];
  list.forEach((f,i)=>{
    const o = document.createElement("option");
    o.value = String(i);
    o.textContent = f.label;
    sel.appendChild(o);
  });
  sel.disabled = list.length === 0;
}

function setActiveSensor(body, idx){
  const f = (CAMERA_DB[body] || [])[idx];
  activeSensorMM = f ? f.vmm : null;
}

function normalizeNumbers(){
  if ($("focal").value !== "") {
    const v = Number($("focal").value);
    if (!Number.isNaN(v)) $("focal").value = String(Math.ceil(v));
  }
  if ($("inches").value !== "") {
    const v = Number($("inches").value);
    if (!Number.isNaN(v)) $("inches").value = String(Math.ceil(v));
  }
  if ($("feet").value !== "") {
    const v = Number($("feet").value);
    if (!Number.isNaN(v)) $("feet").value = String(Math.trunc(v));
  }
  save(LS.focal, $("focal").value);
  save(LS.feet, $("feet").value);
  save(LS.inches, $("inches").value);
}

function calculateTilt(){
  try{
    normalizeNumbers();

    const f = parseFloat($("focal").value);
    const ft = parseFloat($("feet").value);
    const inch = parseFloat($("inches").value);
    const h = parseFloat($("lr_height").value);
    const z = parseFloat($("lr_offset").value);

    if (!activeSensorMM || [f,ft,inch,h,z].some(x => Number.isNaN(x)) || f === 0){
      $("result").innerText = "Tilt Angle —";
      return;
    }

    const d = (ft * 12) + inch; // inches
    const base = Math.atan(-h / (d - z)) * (180 / Math.PI);
    const vfov = 2 * Math.atan((activeSensorMM / 2) / f) * (180 / Math.PI);

    const frame = document.querySelector("input[name='frame']:checked")?.value || "top";
    const pos = frame === "top" ? 0.75 : frame === "middle" ? 0.5 : 0.25;

    const final = base + (vfov / 2) * (0.5 - pos);
    $("result").innerText = `Tilt Angle: ${final.toFixed(2)}°`;
  } catch {
    $("result").innerText = "Tilt Angle —";
  }
}

function clearAll(){
  Object.values(LS).forEach(k => del(k));

  ["focal","feet","inches","lr_offset","lr_height"].forEach(id => $(id).value = "");
  document.querySelector("input[name='frame'][value='top']").checked = true;

  $("cameraBody").value = "";
  $("formatMode").innerHTML = `<option value="">-- Select Format --</option>`;
  $("formatMode").disabled = true;

  activeSensorMM = null;
  $("result").innerText = "Tilt Angle —";
}

function restore(){
  ["focal","feet","inches","lr_offset","lr_height"].forEach(id=>{
    const v = load(LS[id]);
    if (v !== null) $(id).value = v;
  });

  const fr = load(LS.frame);
  if (fr){
    const r = document.querySelector(`input[name="frame"][value="${fr}"]`);
    if (r) r.checked = true;
  }

  const body = load(LS.cameraBody);
  if (body && CAMERA_DB[body]){
    $("cameraBody").value = body;
    populateFormats(body);

    const fmt = load(LS.formatMode);
    if (fmt !== null && fmt !== ""){
      $("formatMode").value = fmt;
      setActiveSensor(body, Number(fmt));
    }
  }
}

function bind(){
  ["focal","feet","inches","lr_offset","lr_height"].forEach(id=>{
    $(id).addEventListener("input", ()=> save(LS[id], $(id).value));
    $(id).addEventListener("change", ()=> save(LS[id], $(id).value));
  });

  document.querySelectorAll('input[name="frame"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      const v = document.querySelector('input[name="frame"]:checked')?.value || "top";
      save(LS.frame, v);
    });
  });

  $("cameraBody").addEventListener("change", ()=>{
    const body = $("cameraBody").value;
    save(LS.cameraBody, body);

    populateFormats(body);

    $("formatMode").value = "";
    save(LS.formatMode, "");

    activeSensorMM = null;
    $("result").innerText = "Tilt Angle —";
  });

  $("formatMode").addEventListener("change", ()=>{
    const body = $("cameraBody").value;
    const idx = $("formatMode").value;
    save(LS.formatMode, idx);

    if (idx === ""){
      activeSensorMM = null;
      $("result").innerText = "Tilt Angle —";
      return;
    }
    setActiveSensor(body, Number(idx));
  });

  $("calcBtn").addEventListener("click", calculateTilt);
  $("resetBtn").addEventListener("click", clearAll);
}

if ("serviceWorker" in navigator){
  window.addEventListener("load", ()=> navigator.serviceWorker.register("./sw.js"));
}

populateBodies();
restore();
bind();
</script>
</body>
</html>
